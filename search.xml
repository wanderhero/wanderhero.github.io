<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[使用 Java 实现 PCM 格式 转 WAV 格式并分别通过 Swing 和 Web 的形式绘制波形图]]></title>
      <url>/2017/05/19/20170519%20-%20%E9%80%9A%E8%BF%87-Java-%E5%AE%9E%E7%8E%B0-pcm-%E6%A0%BC%E5%BC%8F-%E8%BD%AC-wav-%E6%A0%BC%E5%BC%8F%E5%B9%B6%E5%88%86%E5%88%AB%E9%80%9A%E8%BF%87-Swing-%E5%92%8C-Web-%E7%9A%84%E5%BD%A2%E5%BC%8F%E7%BB%98%E5%88%B6%E6%B3%A2%E5%BD%A2%E5%9B%BE/</url>
      <content type="html"><![CDATA[<ul>
<li>使用 Java 实现 pcm 格式 转 wav 格式，具体查看<a href="https://github.com/wanderhero/test-normal-maven/tree/master/src/main/java/com/wander/wave/pcm" target="_blank" rel="external">https://github.com/wanderhero/test-normal-maven/tree/master/src/main/java/com/wander/wave/pcm</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">package com.wander.wave.pcm;</div><div class="line"></div><div class="line">import java.io.FileInputStream;</div><div class="line">import java.io.FileOutputStream;</div><div class="line"></div><div class="line">public class PcmToWavUtil &#123;</div><div class="line"></div><div class="line">    public static void convert(String src, String target) throws Exception &#123;</div><div class="line">        FileInputStream fis = new FileInputStream(src);</div><div class="line">        FileOutputStream fos = new FileOutputStream(target);</div><div class="line"></div><div class="line">        // 计算长度</div><div class="line">        int pcmSize = fis.available();// 由于音频文件一般不会大于 Int 最大值，所以使用 available</div><div class="line"></div><div class="line">        // 填入参数，比特率等等。这里用的是 16位 单声道 8000 hz</div><div class="line">        WavHeader header = new WavHeader();</div><div class="line">        // 长度字段 = 内容的大小（PCMSize) + 头部字段的大小(不包括前面4字节的标识符RIFF以及fileLength本身的4字节)</div><div class="line">        header.fileLength = pcmSize + (44 - 8);</div><div class="line">        header.fmtHdrLeth = 16;</div><div class="line">        header.bitsPerSample = 16;</div><div class="line">        header.channels = 1;</div><div class="line">        header.formatTag = 0x0001;</div><div class="line">        header.samplesPerSec = 8000;</div><div class="line">        header.blockAlign = (short) (header.channels * header.bitsPerSample / 8);</div><div class="line">        header.avgBytesPerSec = header.blockAlign * header.samplesPerSec;</div><div class="line">        header.dataHdrLeth = pcmSize;</div><div class="line"></div><div class="line">        byte[] h = header.getHeader();</div><div class="line"></div><div class="line">        assert h.length == 44;// WAV标准，头部应该是44字节</div><div class="line">        // write header</div><div class="line">        fos.write(h, 0, h.length);</div><div class="line">        // write data stream</div><div class="line">        byte[] buf = new byte[1024 * 4];</div><div class="line">        int size = fis.read(buf);</div><div class="line">        <span class="keyword">while</span> (size != -1) &#123;</div><div class="line">            fos.write(buf, 0, size);</div><div class="line">            size = fis.read(buf);</div><div class="line">        &#125;</div><div class="line">        fis.close();</div><div class="line">        fos.close();</div><div class="line">        System.out.println(<span class="string">"Convert OK!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<a id="more"></a>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line">package com.wander.wave.pcm;</div><div class="line"></div><div class="line">import java.io.ByteArrayOutputStream;</div><div class="line">import java.io.IOException;</div><div class="line"></div><div class="line">public class WavHeader &#123;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 4 资源交换文件标志（RIFF）</div><div class="line">     */</div><div class="line">    public final char fileID[] = &#123;<span class="string">'R'</span>, <span class="string">'I'</span>, <span class="string">'F'</span>, <span class="string">'F'</span>&#125;;</div><div class="line">    /**</div><div class="line">     * 4 总字节数</div><div class="line">     */</div><div class="line">    public int fileLength;</div><div class="line">    /**</div><div class="line">     * 4 WAV文件标志（WAVE）</div><div class="line">     */</div><div class="line">    public char wavTag[] = &#123;<span class="string">'W'</span>, <span class="string">'A'</span>, <span class="string">'V'</span>, <span class="string">'E'</span>&#125;;</div><div class="line">    /**</div><div class="line">     * 4 波形格式标志（fmt ），最后一位空格</div><div class="line">     */</div><div class="line">    public char fmtHdrID[] = &#123;<span class="string">'f'</span>, <span class="string">'m'</span>, <span class="string">'t'</span>, <span class="string">' '</span>&#125;;</div><div class="line">    /**</div><div class="line">     * 4 过滤字节（一般为00000010H），若为00000012H则说明数据头携带附加信息</div><div class="line">     */</div><div class="line">    public int fmtHdrLeth;</div><div class="line">    /**</div><div class="line">     * 2 格式种类（值为1时，表示数据为线性PCM编码）</div><div class="line">     */</div><div class="line">    public short formatTag;</div><div class="line">    /**</div><div class="line">     * 2 通道数，单声道为1，双声道为2</div><div class="line">     */</div><div class="line">    public short channels;</div><div class="line">    /**</div><div class="line">     * 4 采样频率</div><div class="line">     */</div><div class="line">    public int samplesPerSec;</div><div class="line">    /**</div><div class="line">     * 4 波形数据传输速率（每秒平均字节数）</div><div class="line">     */</div><div class="line">    public int avgBytesPerSec;</div><div class="line">    /**</div><div class="line">     * 2 DATA数据块长度，字节</div><div class="line">     */</div><div class="line">    public short blockAlign;</div><div class="line">    /**</div><div class="line">     * 2 PCM位宽</div><div class="line">     */</div><div class="line">    public short bitsPerSample;</div><div class="line">    /**</div><div class="line">     * 4 数据标志符（data）</div><div class="line">     */</div><div class="line">    public char dataHdrID[] = &#123;<span class="string">'d'</span>, <span class="string">'a'</span>, <span class="string">'t'</span>, <span class="string">'a'</span>&#125;;</div><div class="line">    /**</div><div class="line">     * 4 DATA总数据长度字节</div><div class="line">     */</div><div class="line">    public int dataHdrLeth;</div><div class="line"></div><div class="line">    public byte[] getHeader() throws IOException &#123;</div><div class="line">        ByteArrayOutputStream bos = new ByteArrayOutputStream();</div><div class="line">        WriteChar(bos, fileID);</div><div class="line">        WriteInt(bos, fileLength);</div><div class="line">        WriteChar(bos, wavTag);</div><div class="line">        WriteChar(bos, fmtHdrID);</div><div class="line">        WriteInt(bos, fmtHdrLeth);</div><div class="line">        WriteShort(bos, formatTag);</div><div class="line">        WriteShort(bos, channels);</div><div class="line">        WriteInt(bos, samplesPerSec);</div><div class="line">        WriteInt(bos, avgBytesPerSec);</div><div class="line">        WriteShort(bos, blockAlign);</div><div class="line">        WriteShort(bos, bitsPerSample);</div><div class="line">        WriteChar(bos, dataHdrID);</div><div class="line">        WriteInt(bos, dataHdrLeth);</div><div class="line">        bos.flush();</div><div class="line">        byte[] r = bos.toByteArray();</div><div class="line">        bos.close();</div><div class="line">        <span class="built_in">return</span> r;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void WriteShort(ByteArrayOutputStream bos, int s) throws IOException &#123;</div><div class="line">        byte[] mybyte = new byte[2];</div><div class="line">        mybyte[1] = (byte) ((s &lt;&lt; 16) &gt;&gt; 24);</div><div class="line">        mybyte[0] = (byte) ((s &lt;&lt; 24) &gt;&gt; 24);</div><div class="line">        bos.write(mybyte);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void WriteInt(ByteArrayOutputStream bos, int n) throws IOException &#123;</div><div class="line">        byte[] buf = new byte[4];</div><div class="line">        buf[3] = (byte) (n &gt;&gt; 24);</div><div class="line">        buf[2] = (byte) ((n &lt;&lt; 8) &gt;&gt; 24);</div><div class="line">        buf[1] = (byte) ((n &lt;&lt; 16) &gt;&gt; 24);</div><div class="line">        buf[0] = (byte) ((n &lt;&lt; 24) &gt;&gt; 24);</div><div class="line">        bos.write(buf);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void WriteChar(ByteArrayOutputStream bos, char[] id) &#123;</div><div class="line">        <span class="keyword">for</span> (int i = 0; i &lt; id.length; i++) &#123;</div><div class="line">            char c = id[i];</div><div class="line">            bos.write(c);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通过 Swing 的形式绘制波形图，核心代码如下，具体查看<a href="https://github.com/wanderhero/test-normal-maven/tree/master/src/main/java/com/wander/wave/wav" target="_blank" rel="external">https://github.com/wanderhero/test-normal-maven/tree/master/src/main/java/com/wander/wave/wav</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">package com.wander.wave.wav;</div><div class="line"></div><div class="line">import com.wander.wave.plot.Plot;</div><div class="line">import com.wander.wave.plot.PlotFrame;</div><div class="line"></div><div class="line">public class WavUtil &#123;</div><div class="line"></div><div class="line">    // int 数组 转换到 double数组</div><div class="line">    // JavaPlot 只支持double数组的绘制</div><div class="line">    private static double[] Integers2Doubles(int[] raw) &#123;</div><div class="line">        double[] res = new double[raw.length];</div><div class="line">        <span class="keyword">for</span> (int i = 0; i &lt; res.length; i++) &#123;</div><div class="line">            res[i] = raw[i];</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">return</span> res;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 绘制波形文件</div><div class="line">    public static void drawWaveFile(String filename) &#123;</div><div class="line">        WaveFileReader reader = new WaveFileReader(filename);</div><div class="line"></div><div class="line">        String[] pamss = new String[]&#123;<span class="string">"-r"</span>, <span class="string">"-g"</span>, <span class="string">"-b"</span>&#125;;</div><div class="line">        <span class="keyword">if</span> (reader.isSuccess()) &#123;</div><div class="line">            PlotFrame frame = Plot.figrue(String.format(<span class="string">"%s %dHZ %dBit %dCH"</span>, filename, reader.getSampleRate(), reader.getBitPerSample(), reader.getNumChannels()));</div><div class="line">            frame.setSize(800, 400);</div><div class="line">            Plot.hold_on();</div><div class="line">            <span class="keyword">for</span> (int i = 0; i &lt; reader.getNumChannels(); ++i) &#123;</div><div class="line">                // 获取i声道数据</div><div class="line">                int[] data = reader.getData()[i];</div><div class="line">                // 绘图</div><div class="line">                Plot.plot(Integers2Doubles(data), pamss[i % pamss.length]);</div><div class="line">            &#125;</div><div class="line">            Plot.hold_off();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            System.err.println(filename + <span class="string">"不是一个正常的wav文件"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通过 Web 的形式绘制波形图，核心代码如下，具体参考<a href="https://github.com/katspaugh/wavesurfer.js" target="_blank" rel="external">https://github.com/katspaugh/wavesurfer.js</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html lang=<span class="string">"en"</span>&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>/&gt;</div><div class="line">    &lt;title&gt;Title&lt;/title&gt;</div><div class="line">    &lt;script src=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/1.2.3/wavesurfer.min.js"</span>&gt;&lt;/script&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    &lt;div id=<span class="string">"waveform"</span>&gt;&lt;/div&gt;</div><div class="line">    &lt;div style=<span class="string">"text-align: center"</span>&gt;</div><div class="line">        &lt;p class=<span class="string">"row"</span>&gt;&lt;/p&gt;</div><div class="line">        &lt;div class=<span class="string">"col-xs-1"</span>&gt;</div><div class="line">            &lt;i class=<span class="string">"glyphicon glyphicon-zoom-in"</span>&gt;&lt;/i&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line"></div><div class="line">        &lt;div class=<span class="string">"col-xs-10"</span>&gt;</div><div class="line">            &lt;input id=<span class="string">"slider"</span> <span class="built_in">type</span>=<span class="string">"range"</span> min=<span class="string">"1"</span> max=<span class="string">"200"</span> value=<span class="string">"1"</span> style=<span class="string">"width: 100%"</span>/&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line"></div><div class="line">        &lt;div class=<span class="string">"col-xs-1"</span>&gt;</div><div class="line">            &lt;i class=<span class="string">"glyphicon glyphicon-zoom-out"</span>&gt;&lt;/i&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;p&gt;&lt;/p&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line"></div><div class="line">    &lt;script&gt;</div><div class="line">        var wavesurfer = WaveSurfer.create(&#123;</div><div class="line">            container: <span class="string">'#waveform'</span>,</div><div class="line">            waveColor: <span class="string">'red'</span>,</div><div class="line">            progressColor: <span class="string">'purple'</span></div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        wavesurfer.load(<span class="string">'https://ia902606.us.archive.org/35/items/shortpoetry_047_librivox/song_cjrg_teasdale_64kb.mp3'</span>);</div><div class="line"></div><div class="line">        var slider = document.querySelector(<span class="string">'#slider'</span>);</div><div class="line"></div><div class="line">        slider.oninput = <span class="function"><span class="title">function</span></span> () &#123;</div><div class="line">            var zoomLevel = Number(slider.value);</div><div class="line">            wavesurfer.zoom(zoomLevel);</div><div class="line">        &#125;;</div><div class="line">    &lt;/script&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<hr>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>&emsp;&emsp;平时听歌的时候不会去关注这音频是怎么产生的，最近需要处理 pcm 格式相关的文件，从一脸懵逼到略有所获，还是有点意思的~</p>
<h3 id="pcm-格式-转-wav-格式"><a href="#pcm-格式-转-wav-格式" class="headerlink" title="pcm 格式 转 wav 格式"></a>pcm 格式 转 wav 格式</h3><p>&emsp;&emsp;本来想着有没有什么方法可以一步到位直接把 pcm 的波形绘制出来的，找了半天发现 Adobe Audition 工具是可以直接查看的，却没有可用的代码方式，更多的是如何绘制 wav 波形，那就只能退而求其次，曲线救国了。<br>&emsp;&emsp;在这之前，还是先了解下什么是 pcm，什么又是 wav，不然就是瞎子摸象了。<br>&emsp;&emsp;根据<a href="#参考1">百度百科</a>上对 pcm 的解释，大致如下。PCM 即脉冲编码调制(Pulse Code Modulation)，把一个时间连续，取值连续的模拟信号变换成时间离散，取值离散的数字信号后在信道中传输，也就是对模拟信号先抽样，再对样值幅度量化，编码的过程。与模拟信号比，它不易受传送系统的杂波及失真的影响。<br>&emsp;&emsp;再看<a href="#参考2">百度百科</a>对 wav 的解释，WAV 为微软公司开发的一种声音文件格式，它符合 RIFF(Resource Interchange File Format) 文件规范，用于保存 Windows 平台的音频信息资源，被Windows平台及其应用程序所广泛支持，是最接近无损的音乐格式。<br> &emsp;&emsp;简单来说：wav 是一种无损的音频文件格式，pcm 是没有压缩的编码方式。pcm 加上 wav 文件头就可以转为 wav 格式，但 wav 还可以用其它方式编码。<br>&emsp;&emsp;那问题也就明确了，网上有多种版本的 pcm 转 wav，有 c++ 的，也有基于 android sdk 的，和 Java 标准库还是有区别的，最后感谢 <a href="#参考3">xiunai78的专栏 - PCM到WAV的转换(Java)</a>，亲测可用。本文稍微做了修改，由于音频文件一般不会大于 int 最大值，所以使用 available() 方法直接获取 pcm 文件的长度，简单快速。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int pcmSize = fis.available();</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;看了代码以后，再对比了 wav 头文件的组成，对 [<strong>pcm 加上 wav 文件头就可以转为 wav 格式</strong>] 这句话就更有体会了。  </p>
<table>
<thead>
<tr>
<th>大小字节</th>
<th>数据块类型</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>4字符</td>
<td>资源交换文件标志（RIFF）</td>
</tr>
<tr>
<td>4</td>
<td>长整数</td>
<td>从下个地址开始到文件尾的总字节数</td>
</tr>
<tr>
<td>4</td>
<td>4字符</td>
<td>WAV文件标志（WAVE）</td>
</tr>
<tr>
<td>4</td>
<td>4字符</td>
<td>波形格式标志（fmt ），最后一位空格。</td>
</tr>
<tr>
<td>4</td>
<td>整数</td>
<td>过滤字节（一般为00000010H），若为00000012H则说明数据头携带附加信息（见“附加信息”）。</td>
</tr>
<tr>
<td>2</td>
<td>整数</td>
<td>格式种类（值为1时，表示数据为线性PCM编码）</td>
</tr>
<tr>
<td>2</td>
<td>整数</td>
<td>通道数，单声道为1，双声道为2</td>
</tr>
<tr>
<td>4</td>
<td>长整数</td>
<td>采样频率</td>
</tr>
<tr>
<td>4</td>
<td>长整数</td>
<td>波形数据传输速率（每秒平均字节数）</td>
</tr>
<tr>
<td>2</td>
<td>整数</td>
<td>DATA数据块长度，字节。</td>
</tr>
<tr>
<td>2</td>
<td>整数</td>
<td>PCM位宽</td>
</tr>
<tr>
<td>4</td>
<td>4字符</td>
<td>数据标志符（data）</td>
</tr>
<tr>
<td>4</td>
<td>长整型</td>
<td>DATA总数据长度字节</td>
</tr>
</tbody>
</table>
<h3 id="通过-Swing-的形式绘制波形图"><a href="#通过-Swing-的形式绘制波形图" class="headerlink" title="通过 Swing 的形式绘制波形图"></a>通过 Swing 的形式绘制波形图</h3><p>&emsp;&emsp;拿到了 wav 文件，接下来就是如何绘制了。刚开始想到的是在本地展现，于是就看到了 <a href="#参考4">sintrb 提供的 WaveAccess 方法</a>，传入文件的绝对路径，就可以方便得绘制出波形。<br><img src="https://raw.githubusercontent.com/sintrb/WaveAccess/master/doc/screenshots/shots_wav_40_16_1_pcm.png" alt=""><br>&emsp;&emsp;这里忠于原著，即用了作者的代码，也盗了作者的图片，本文只做了略微改动，把键盘快捷键的 z 和 x 改成了波形的缩放键。<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public void keyPressed(KeyEvent e) &#123;</div><div class="line">    if (e.getKeyCode() == KeyEvent.VK_Z) &#123;</div><div class="line">        panle.zoom(1.0f + 0.1, 1.0f);</div><div class="line">        return;</div><div class="line">    &#125; else if (e.getKeyCode() == KeyEvent.VK_X) &#123;</div><div class="line">        panle.zoom(1.0f - 0.1, 1.0f);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="通过-Web-的形式绘制波形图"><a href="#通过-Web-的形式绘制波形图" class="headerlink" title="通过 Web 的形式绘制波形图"></a>通过 Web 的形式绘制波形图</h3><p>&emsp;&emsp;Swing 形式只能在本地使用，在远程浏览器上是看不到界面的，没办法，还是得采用 web 的形式来展现。在寻寻觅觅了良久以后，盼到了佳音<a href="#参考5">wavesurfer.js</a>，接入方便，功能强大，本文只用到了显示和缩放功能<br><a href="http://wander.u.qiniudn.com/20170519-1812-0.0.png?imageslim" target="_blank" rel="external"><img src="http://wander.u.qiniudn.com/20170519-1812-0.0.png?imageView2/2/h/100/imageslim" alt=""></a><br>&emsp;&emsp;这里需要注意的是 [<strong>wavesurfer.load</strong>] 不支持文件的绝对路径，只能是同域的相对路径和跨域的 URL，原文如下：<br>You can load files either from the same domain:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wavesurfer.load(&apos;../audio/song.mp3&apos;);</div></pre></td></tr></table></figure></p>
<p>Or from another server, if it supports CORS headers. For example:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wavesurfer.load(&apos;http://ia902606.us.archive.org/35/items/shortpoetry_047_librivox/song_cjrg_teasdale_64kb.mp3&apos;);</div></pre></td></tr></table></figure></p>
<h3 id="感触"><a href="#感触" class="headerlink" title="感触"></a>感触</h3><p>&emsp;&emsp;这是一个神奇的时代，一切因为计算机而变得如此多彩而奇妙~~~</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><span id="参考1"><a href="http://baike.baidu.com/item/PCM/1568054" target="_blank" rel="external">百度百科 - PCM</a></span>  </li>
<li><span id="参考2"><a href="http://baike.baidu.com/item/WAV" target="_blank" rel="external">百度百科 - WAV</a></span> </li>
<li><span id="参考3"><a href="http://blog.csdn.net/xiunai78/article/details/6867331" target="_blank" rel="external">xiunai78的专栏 - PCM到WAV的转换(Java)</a></span> </li>
<li><span id="参考4"><a href="https://github.com/sintrb/WaveAccess/" target="_blank" rel="external">Github - sintrb/WaveAccess</a></span> </li>
<li><span id="参考5"><a href="https://wavesurfer-js.org/" target="_blank" rel="external">wavesurfer.js</a></span> </li>
</ul>
]]></content>
      
        <categories>
            
            <category> Java </category>
            
            <category> Audio </category>
            
            <category> Wave </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
            <tag> Audio </tag>
            
            <tag> Wave </tag>
            
            <tag> pcm </tag>
            
            <tag> wav </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java 通过 JNI 调用 so/jnilib 动态链接库]]></title>
      <url>/2017/05/14/20170514%20-%20Java-%E9%80%9A%E8%BF%87-JNI-%E8%B0%83%E7%94%A8-so-jnilib-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/</url>
      <content type="html"><![CDATA[<p>&emsp;&emsp;本文用的是 <strong>JDK 1.7</strong> 版本，使用 <strong>Ubuntu 14.04.2 LTS</strong> 编译 so，<strong>macOS Sierra 10.12.4</strong> 编译 jnilib。<br>主要步骤就如下三步，具体代码见 <a href="https://github.com/wanderhero/test-normal-project" target="_blank" rel="external"><strong>https://github.com/wanderhero/test-normal-project.git</strong></a>：<br>&emsp;&emsp;1.加载实现了 native 函数的动态库；<br>&emsp;&emsp;2.声明 native 函数；<br>&emsp;&emsp;3.调用 native 函数。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">package com.wander.jni;</div><div class="line"></div><div class="line">public class JNITest &#123;</div><div class="line">	static &#123;</div><div class="line">		System.loadLibrary(<span class="string">"JNITest"</span>);// 加载实现了native函数的动态库</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public static native String <span class="built_in">test</span>(String name);// 声明native函数</div><div class="line"></div><div class="line">	public static void main(String[] args) &#123;</div><div class="line">		System.out.println(<span class="built_in">test</span>(<span class="string">"wander"</span>));// 调用 native 函数</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<hr>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>&emsp;&emsp;其实 Java 方面不是大问题，关键问题在于如何生成 动态链接库。首先还是先了解下什么是 JNI，才能知己知彼，百战不殆。<br>&emsp;&emsp;参考自 <a href="#参考1"><strong>xyang0917</strong></a>，JNI 全称是 Java Native Interface (Java本地接口) 单词首字母的缩写，本地接口就是指用 C 和 C++ 开发的接口。由于 JNI 是 JVM 规范中的一部份，因此可以将我们写的 JNI 程序在任何实现了 JNI 规范的 Java 虚拟机中运行。同时，这个特性使我们可以复用以前用 C/C++ 写的大量代码。<br>&emsp;&emsp;开发 JNI 程序会受到系统环境的限制，因为用 C/C++ 语言写出来的代码或模块，编译过程当中要依赖当前操作系统环境所提供的一些库函数，并和本地库链接在一起。而且编译后生成的二进制代码只能在本地操作系统环境下运行，因为不同的操作系统环境，有自己的本地库和 CPU 指令集，而且各个平台对标准 C/C++ 的规范和标准库函数实现方式也有所区别。这就造成使用了 JNI 接口的 JAVA 程序，不再像以前那样自由的跨平台。如果要实现跨平台，就必须将本地代码在不同的操作系统平台下编译出相应的动态库(<strong>windows：#.dll, linux/unix：lib#.so, mac os x：lib#.jnilib</strong>)。  </p>
<h3 id="生成-C-C-代码"><a href="#生成-C-C-代码" class="headerlink" title="生成 C/C++ 代码"></a>生成 C/C++ 代码</h3><p>&emsp;&emsp;如果已有 C/C++ 文件，可跳过此步。<br>&emsp;&emsp;最开始我们已经新建了一个 <strong>JNITest.java</strong> 源文件，那就基于此文件快速生成 .h 头文件。  </p>
<ul>
<li><strong>首先获取 .class 字节码文件，如果没有生成，可以通过 javac 命令将 .java 源文件编译而成。</strong><br>注意是在工程根目录下，-d 表示将编译后的 class 文件放到指定的目录下，这里我把它放到和 src 同级的 bin 目录下。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">192:<span class="built_in">test</span>-normal-project wander$ javac src/com/wander/jni/JNITest.java <span class="_">-d</span> ./bin</div></pre></td></tr></table></figure>
<ul>
<li><strong>然后就可以用 javah -jni 命令，根据 class 字节码文件生成 .h 头文件。</strong><br>默认生成的 .h 头文件名为 com_wander_jni_JNITest.h（包名+类名.h），我把它放在和 src 同级的 res/jni 目录下。    </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ javah -jni -classpath ./bin <span class="_">-d</span> ./res/jni com.wander.jni.JNITest</div></pre></td></tr></table></figure>
<p>&emsp;&emsp;&emsp;也可以通过 -o 参数指定生成头文件名称，注意不能和 -d 混用，默认生成到同级目录下。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ javah -jni -classpath ./bin -o JNITest.h com.wander.jni.JNITest</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;&emsp;参数说明，注意：-d 和 -o 只能使用其中一个参数，具体查看 <strong>javah -help</strong>：<br>&emsp;&emsp;&emsp;&emsp;-classpath ：类搜索路径，这里表示从当前的 bin 目录下查找<br>&emsp;&emsp;&emsp;&emsp;-d ：将生成的头文件放到当前的 res/jni 目录下<br>&emsp;&emsp;&emsp;&emsp;-o ：指定生成的头文件名称  </p>
<p>&emsp;&emsp;&emsp;生成的 .h 头文件如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">/* DO NOT EDIT THIS FILE - it is machine generated */</div><div class="line"><span class="comment">#include &lt;jni.h&gt;</span></div><div class="line">/* Header <span class="keyword">for</span> class com_wander_jni_JNITest */</div><div class="line"></div><div class="line"><span class="comment">#ifndef _Included_com_wander_jni_JNITest</span></div><div class="line"><span class="comment">#define _Included_com_wander_jni_JNITest</span></div><div class="line"><span class="comment">#ifdef __cplusplus</span></div><div class="line">extern <span class="string">"C"</span> &#123;</div><div class="line"><span class="comment">#endif</span></div><div class="line">/*</div><div class="line"> * Class:     com_wander_jni_JNITest</div><div class="line"> * Method:    <span class="built_in">test</span></div><div class="line"> * Signature: (Ljava/lang/String;)Ljava/lang/String;</div><div class="line"> */</div><div class="line">JNIEXPORT jstring JNICALL Java_com_wander_jni_JNITest_test</div><div class="line">  (JNIEnv *, jclass, jstring);</div><div class="line"></div><div class="line"><span class="comment">#ifdef __cplusplus</span></div><div class="line">&#125;</div><div class="line"><span class="comment">#endif</span></div><div class="line"><span class="comment">#endif</span></div></pre></td></tr></table></figure></p>
<ul>
<li><strong>最后根据 .h头文件生成 .c 文件</strong><br>此处我在 c 里面打印 <strong>Hello ${name}</strong>，同时返回 <strong>return ${name}</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">// com_wander_jni_JNITest.c  </div><div class="line">  </div><div class="line"><span class="comment">#include "com_wander_jni_JNITest.h"  </span></div><div class="line">  </div><div class="line"><span class="comment">#ifdef __cplusplus  </span></div><div class="line">extern <span class="string">"C"</span>  </div><div class="line">&#123;  </div><div class="line"><span class="comment">#endif   </span></div><div class="line">/*</div><div class="line"> * Class:     com_wander_jni_JNITest</div><div class="line"> * Method:    <span class="built_in">test</span></div><div class="line"> * Signature: (Ljava/lang/String;)Ljava/lang/String;</div><div class="line"> */</div><div class="line">JNIEXPORT jstring JNICALL Java_com_wander_jni_JNITest_test(  </div><div class="line">        JNIEnv *env, jclass cls, jstring j_str) </div><div class="line">&#123;  </div><div class="line">    const char *c_str = NULL;  </div><div class="line">    char buff[128] = &#123; 0 &#125;;  </div><div class="line">    c_str = (*env)-&gt;GetStringUTFChars(env, j_str, NULL);  </div><div class="line">    <span class="keyword">if</span> (c_str == NULL)  </div><div class="line">    &#123;  </div><div class="line">        <span class="built_in">printf</span>(<span class="string">"out of memory.\n"</span>);  </div><div class="line">        <span class="built_in">return</span> NULL;  </div><div class="line">    &#125;  </div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Hello %s in c\n"</span>, c_str);  </div><div class="line">    sprintf(buff, <span class="string">"return %s"</span>, c_str);  </div><div class="line">    (*env)-&gt;ReleaseStringUTFChars(env, j_str, c_str);  </div><div class="line">    <span class="built_in">return</span> (*env)-&gt;NewStringUTF(env, buff);  </div><div class="line">&#125;  </div><div class="line"><span class="comment">#ifdef __cplusplus  </span></div><div class="line">&#125;  </div><div class="line"><span class="comment">#endif</span></div></pre></td></tr></table></figure>
<h3 id="将-C-C-代码编译成动态库文件"><a href="#将-C-C-代码编译成动态库文件" class="headerlink" title="将 C/C++ 代码编译成动态库文件"></a>将 C/C++ 代码编译成动态库文件</h3><p>&emsp;&emsp;最近爆发了 比特币勒索病毒，三个操作系统的优劣好差估计又有谈资了。</p>
<ul>
<li><strong>Linux/Unix</strong><br>参数说明：<br>&emsp;-I：包含编译JNI必要的头文件<br>&emsp;-fPIC：编译成与位置无关的独立代码<br>&emsp;-shared：编译成动态库<br>&emsp;-o：指定编译后动态库生成的路径和文件名<br>本文用的是 阿里云 的 Ubuntu 14.04.2 LTS，把 .h 和 .c 文件放到同一目录下，通过 gcc 命令一步生成 libJNITest.so。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ gcc -I<span class="variable">$JAVA_HOME</span>/include -I<span class="variable">$JAVA_HOME</span>/include/linux <span class="_">-f</span>PIC -shared com_wander_jni_JNITest.c -o libJNITest.so</div></pre></td></tr></table></figure>
<ul>
<li><strong>Mac OS X</strong><br>参数说明：<br>&emsp;-dynamiclib：表示编译成动态链接库<br>&emsp;-o：指定动态链接库编译后生成的路径及文件名<br>&emsp;-framework JavaVM -I：编译JNI需要用到JVM的头文件(jni.h)，第一个目录是平台无关的，第二个目录是与操作系统平台相关的头文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ gcc -dynamiclib -o libJNITest.jnilib com_wander_jni_JNITest.c -framework JavaVM -I/<span class="variable">$JAVA_HOME</span>/include -I/<span class="variable">$JAVA_HOME</span>/include/darwin</div></pre></td></tr></table></figure>
<p>&emsp;&emsp;&emsp;看上去也很简单，但是在我的电脑上却报错了，提示 <strong>‘jni.h’ file not found(找不到 jni 头文件)</strong>，感谢 <a href="#参考2"><strong>Stack Overflow</strong></a>，找到了貌似正确的命令，却提示 <strong>Operation not permitted(不允许操作)</strong>，加了 sudo 都不行，难道我的人品差到连系统都不忍直视了吗？事实证明，人品是挺差的，但功夫不负有心人，感谢 <a href="#参考3"><strong>小胡子哥</strong></a>，原来 Apple 在 OS X 10.11 以后的版本中默认启动了一项系统保护程序，叫做 System Integrity Protection，也被唤作 rootless（寓意让 root 弱一点），该程序意在保护电脑不被恶意程序攻击，感觉屌屌的，以安全的名义，一切都是可以接受的。<br>&emsp;&emsp;&emsp;SIP 会锁定几个系统文件目录：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/System</div><div class="line">/sbin</div><div class="line">/usr （/usr/<span class="built_in">local</span> 除外）</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;&emsp;在 SIP 的保护下，部分软件、功能、脚本都会失效，还好 mac 提供了命令，我们可以通过 csrutil 来检测系统当前 SIP 的启动状态、打开或关闭此功能。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ csrutil status</div><div class="line">System Integrity Protection status: enabled.</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;&emsp;enabled 说明当前我的系统是在 SIP 保护下的，我们可以通过如下步骤关闭 SIP，以防万一，可以先做个 Time Machine 备份：<br>&emsp;&emsp;&emsp;&emsp;- 重启电脑，按下 Command + R 直到听到开机声音，此时电脑会进入恢复模式（Recovery Mode）<br>&emsp;&emsp;&emsp;&emsp;- 当 macOS 实用工具出现在屏幕中时，选择 实用工具(Utilities) 菜单，选择 终端(Terminal)<br>&emsp;&emsp;&emsp;&emsp;- 输入 csrutil disable，回车<br>&emsp;&emsp;&emsp;&emsp;- 电脑重启后，SIP 就关闭了<br>&emsp;&emsp;&emsp;恢复 SIP 的方式同上，只不过终端中输入 csrutil enable 即可。</p>
<p><div style="float: left"><a href="http://wander.u.qiniudn.com/20170514-1632-0.0.jpg?imageslim" target="_blank" rel="external"><img src="http://wander.u.qiniudn.com/20170514-1632-0.0.jpg?imageView2/2/h/140/imageslim" alt=""></a></div><a href="http://wander.u.qiniudn.com/20170514-1632-0.1.jpg?imageslim" target="_blank" rel="external"><img src="http://wander.u.qiniudn.com/20170514-1632-0.1.jpg?imageView2/2/h/140/imageslim" alt=""></a>    </p>
<p>&emsp;&emsp;&emsp;关闭了 SIP 后，再来试试之前的 jni 头文件找不到的问题，果然 OK，这里我采用的是 jdk1.7 版本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> /System/Library/Frameworks/JavaVM.framework/Versions</div><div class="line">$ sudo ln -nsf /Library/Java/JavaVirtualMachines/jdk1.7.0_45.jdk/Contents ./CurrentJDK</div><div class="line"></div><div class="line">$ <span class="built_in">cd</span> /System/Library/Frameworks/JavaVM.framework</div><div class="line">$ sudo ln -nsf Versions/CurrentJDK/Home/include/ ./Headers</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;&emsp;问题扫除后，再执行 gcc 命令，libJNITest.jnilib 顺利生成~</p>
<ul>
<li><strong>Windows</strong><br>由于手上没有 Windows 电脑，Windows 的验证暂缺。</li>
</ul>
<h3 id="运行-Java-程序"><a href="#运行-Java-程序" class="headerlink" title="运行 Java 程序"></a>运行 Java 程序</h3><p>&emsp;&emsp;经过了漫长的准备，动态链接库 终于到手，接下来就差最后一把火了。此时如果心急直接运行，程序会毫不留情地抛给你一个 java.lang.UnsatisfiedLinkError 异常，且无法 try catch。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.UnsatisfiedLinkError: no JNITest1 <span class="keyword">in</span> java.library.path</div><div class="line">	at java.lang.ClassLoader.loadLibrary(ClassLoader.java:1886)</div><div class="line">	at java.lang.Runtime.loadLibrary0(Runtime.java:849)</div><div class="line">	at java.lang.System.loadLibrary(System.java:1088)</div><div class="line">	at com.wander.jni.JNITest.&lt;clinit&gt;(JNITest.java:5)</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;一般在类的静态 (static) 代码块中加载动态库最合适，因为在创建类的实例时，类会被 ClassLoader 先加载到虚拟机，随后立马调用类的 static 静态代码块。这时再去调用 native 方法就万无一失了。加载动态库的两种方式：<br>&emsp;&emsp;方法1简单粗暴，指定要调用的动态链接库的绝对路径即可，只是在跨平台访问时，需要指定对应平台的文件路径，且不同平台文件的前缀和后缀都不一样；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.load(<span class="string">"/Users/wander/MyDocuments/workspace/workspace4eclipse/test-normal-project/res/jni/libJNITest.jnilib"</span>);</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;方法2只需要指定动态库的名字即可，不需要前缀后缀，java 会去 java.library.path 系统属性指定的目录下查找动态库文件，一劳永逸；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.loadLibrary(<span class="string">"JNITest"</span>);</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;这里我写了一个简单类去查看 java.library.path 路径，和环境变量一样，每个路径用:分割，随便放到哪个路径下都有效。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">package com.wander.jni;</div><div class="line"></div><div class="line">public class JavaLibraryPath &#123;</div><div class="line">	public static void main(String[] args) &#123;</div><div class="line">		System.out.println(System.getProperty(<span class="string">"java.library.path"</span>));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;做成可执行 Jar 文件，就可以在多平台上运行查看了。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ java -jar JavaLibraryPath.jar</div><div class="line">/usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/lib</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;如此这般，就可以再做个可执行 Jar 文件，在 linux/unix 平台上访问了，mac 系统更是可以在 IDE 里面运行调试了。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ java -jar JNITest.jar </div><div class="line">Hello wander <span class="keyword">in</span> c</div><div class="line"><span class="built_in">return</span> wander</div></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>&emsp;&emsp;不会 C/C++ 的 Java 程序员也可以用好 JNI~</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><span id="参考1"><a href="http://blog.csdn.net/xyang81/article/details/41777471" target="_blank" rel="external">JNI/NDK开发指南（一）—— JNI开发流程及HelloWorld</a></span>  </li>
<li><span id="参考2"><a href="http://stackoverflow.com/questions/9704376/how-to-install-java-native-development-headers-on-os-x-lion" target="_blank" rel="external">Stack Overflow - How to install Java native development headers on OS X Lion</a></span> </li>
<li><span id="参考3"><a href="http://www.barretlee.com/blog/2016/04/06/operation-not-permitted-problem-in-linux-or-unix-system/" target="_blank" rel="external">小胡子哥的个人博客 - Unix/Linux 系统中的 Operation Not Permitted 问题</a></span> </li>
</ul>
]]></content>
      
        <categories>
            
            <category> Java </category>
            
            <category> JNI </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
            <tag> JNI </tag>
            
            <tag> so </tag>
            
            <tag> jnilib </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[IntelliJ IDEA For Mac 导入导出快捷键配置]]></title>
      <url>/2017/05/05/20170505%20-%20IntelliJ-IDEA-For-Mac-%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA%E5%BF%AB%E6%8D%B7%E9%94%AE%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<p>&emsp;&emsp;本文用的是 <code>IntelliJ IDEA 2017.1.1</code> 版本。</p>
<ul>
<li><p><span id="参考0">点击顶部的 <strong>File</strong>，选择 <strong>Export Settings…</strong>；</span><br><a href="http://wander.u.qiniudn.com/20170505-1403-0.0.png?imageslim" target="_blank" rel="external"><img src="http://wander.u.qiniudn.com/20170505-1403-0.0.png?imageView2/2/h/100/imageslim" alt=""></a></p>
</li>
<li><p>默认选择的应该就是 <strong>当前 IntelliJ IDEA 版本所在的配置路径</strong>；<br><a href="http://wander.u.qiniudn.com/20170505-1403-1.0.png?imageslim" target="_blank" rel="external"><img src="http://wander.u.qiniudn.com/20170505-1403-1.0.png?imageView2/2/h/100/imageslim" alt=""></a><br>[不对看这里]如果不是，就选择 <strong>…</strong> 即更多文件，选择 <strong>Recent Flaces</strong> 即最近使用，选择你所使用的 IntelliJIdea 版本；<br><a href="http://wander.u.qiniudn.com/20170505-1403-1.1.png?imageslim" target="_blank" rel="external"><img src="http://wander.u.qiniudn.com/20170505-1403-1.1.png?imageView2/2/h/100/imageslim" alt=""></a></p>
</li>
<li><p>点击 <strong>OK</strong>，如果是第一次 Export，会提示 <strong>Export Complete</strong>，此时不要急着 <strong>Cancel</strong>，而是选择 <strong>Reveal in Finder</strong>；<br><a href="http://wander.u.qiniudn.com/20170505-1403-2.1.png?imageslim" target="_blank" rel="external"><img src="http://wander.u.qiniudn.com/20170505-1403-2.1.png?imageView2/2/h/100/imageslim" alt=""></a><br>[不对看这里]如果不是第一次，则会提示 <strong>File Already Exists</strong>，其实就是该文件已存在，无脑点击 <strong>OK</strong> 即可，后面就是老司机上路了；<br><a href="http://wander.u.qiniudn.com/20170505-1403-2.0.png?imageslim" target="_blank" rel="external"><img src="http://wander.u.qiniudn.com/20170505-1403-2.0.png?imageView2/2/h/100/imageslim" alt=""></a></p>
</li>
<li><p>在打开的文件里找到 <strong>keymaps</strong> 目录，你想要的 <strong>快捷键配置</strong> 文件就静静地躺在那里，特别提醒，<strong>对里面的文件删除或添加，都需要重启 IDEA 才能生效，</strong>enjoy it 吧~<br><a href="http://wander.u.qiniudn.com/20170505-1403-3.png?imageslim" target="_blank" rel="external"><img src="http://wander.u.qiniudn.com/20170505-1403-3.png?imageView2/2/h/100/imageslim" alt=""></a></p>
<a id="more"></a>
</li>
</ul>
<hr>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>&emsp;&emsp;虽然用的最习惯的还是 eclipse，尤其是 MyEclipse，但由于 JetBrains 成功的商业模式，把各个工具的操作都统一了，大势所趋，IntelliJ IDEA 成了新宠。我还不是很熟悉这个新伙伴，今天遇到要把快捷键设置导出的问题就一下子难到了。本以为谷歌在手，天下我有，结果搜了一通，要么是 Windows 版的，要么就是风马牛不相及的快捷键使用说明，竟然没有我大 Mac 的文章，那就让我来献个丑吧~</p>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><p>&emsp;&emsp;前面提到，我已经找到了 <a href="http://blog.csdn.net/jiangfuqiang/article/details/38553011" target="_blank" rel="external">Windows</a> 的方法（<a href="#参考1">见参考</a>），那举一反三，Mac 上的位置呼之欲出。<br>&emsp;&emsp;Windows 下 IDEA 默认快捷键的配置文件所在地（目录前缀自己改）：C:\Program Files (x86)\JetBrains\IntelliJ IDEA xxx\lib\resources.jar\idea\KeyMap_xxx.xml，很显然，Mac 下肯定在 <strong>IntelliJ IDEA.app</strong> 的 <strong>包内容</strong> 里，<a href="http://wander.u.qiniudn.com/20170505-1403-4.0.png?imageslim" target="_blank" rel="external"><img src="http://wander.u.qiniudn.com/20170505-1403-4.0.png?imageView2/2/h/100/imageslim" alt=""></a><strong>resources.jar</strong> 包是顺利找到了，<a href="http://wander.u.qiniudn.com/20170505-1403-4.1.png?imageslim" target="_blank" rel="external"><img src="http://wander.u.qiniudn.com/20170505-1403-4.1.png?imageView2/2/h/100/imageslim" alt=""></a> 但通过 <strong>JD-GUI</strong> 查看了下，可能是版本的问题， <strong>idea</strong> 目录下并没有和 <strong>KeyMap</strong> 有关的文件，而是在同级的 <strong>keymaps</strong> 目录下，和 <strong>偏好设置</strong> 里的 <strong>Keymap</strong> 的设置可以对应起来，说明 默认快捷键的配置 找对了。<br><a href="http://wander.u.qiniudn.com/20170505-1403-4.2.png?imageslim" target="_blank" rel="external"><img src="http://wander.u.qiniudn.com/20170505-1403-4.2.png?imageView2/2/h/100/imageslim" alt=""></a><a href="http://wander.u.qiniudn.com/20170505-1403-4.3.png?imageslim" target="_blank" rel="external"><img src="http://wander.u.qiniudn.com/20170505-1403-4.3.png?imageView2/2/h/100/imageslim" alt=""></a><br>&emsp;&emsp;看了半天，我自定义的快捷键在哪里，这才是重点。Windows 下 IDEA 用户自定义快捷键的配置文件所在地（目录前缀自己改）：C:\Users\Administrator.IntelliJIdea13\config\keymaps*.xml，但 Mac 下的配置放在哪呢，这就比较尴尬了，只能退而求其次，先找下 IntelliJ IDEA For Mac 的配置文件保存路径吧，这就很多了，感谢<a href="http://wiki.jikexueyuan.com/project/intellij-idea-tutorial/installation-directory-introduce.html" target="_blank" rel="external">万能的 Google，无私的网友</a>（<a href="#参考2">见参考</a>），/Users/你的用户名/Library/Preferences/IntelliJIdeaXXXXXX，用于保存你的个人配置，等价于 Windows 下的 config 目录，接下来，不管用 <strong>终端</strong> 还是 <strong>前往文件夹…</strong> 都可以，你喜欢就好。<br><a href="http://wander.u.qiniudn.com/20170505-1403-5.0.png?imageslim" target="_blank" rel="external"><img src="http://wander.u.qiniudn.com/20170505-1403-5.0.png?imageView2/2/h/100/imageslim" alt=""></a><a href="http://wander.u.qiniudn.com/20170505-1403-5.1.png?imageslim" target="_blank" rel="external"><img src="http://wander.u.qiniudn.com/20170505-1403-5.1.png?imageView2/2/h/100/imageslim" alt=""></a><br>&emsp;&emsp;最后，感谢好友 <strong>Stephen</strong> 抛来的问题，又自己找到了<a href="#参考0">最上面所说的最正常最方便的正解</a>，还分享了丰富的<a href="http://color-themes.com/?view=index" target="_blank" rel="external">颜色主题 Color Themes</a>（<a href="#参考3">见参考</a>），下载喜欢的主题，其实就是 jar 包，通过 <strong>Import Settings…</strong> 导入即可，如果想极客一点，可以把 jar 包解包，把文件放到对应的目录下即可。</p>
<h3 id="题外话：保存快捷键配置"><a href="#题外话：保存快捷键配置" class="headerlink" title="题外话：保存快捷键配置"></a>题外话：保存快捷键配置</h3><p>&emsp;&emsp;喜欢的快捷键要好好珍惜，我选择 GitHub 来装逼，<a href="https://github.com/wanderhero/config/blob/master/IntelliJ%20IDEA/keymaps/custom%20Mac%20OS%20X%2010_5_.xml" target="_blank" rel="external"><strong>https://github.com/wanderhero/config.git</strong></a>，其实我就把 <strong>代码补全(Main menu –&gt; Code –&gt; Completion)</strong> 的快捷键改成了 <strong>Alt + 斜杠(⌥/)</strong>，符合国情~</p>
<h3 id="吐槽一下"><a href="#吐槽一下" class="headerlink" title="吐槽一下"></a>吐槽一下</h3><p>&emsp;&emsp;IntelliJ IDEA 要是能在 快捷键配置 界面添加 导入 和 导出 按钮多方便，既然没有，就 PS 下 YY 下吧~<br><a href="http://wander.u.qiniudn.com/20170505-1403-6.1.png?imageslim" target="_blank" rel="external"><img src="http://wander.u.qiniudn.com/20170505-1403-6.1.png?imageView2/2/h/100/imageslim" alt=""></a><br>&emsp;&emsp;对比了下 Eclipse，其实 Eclipse 提供了导出快捷键设置的按钮，可以将当前 Eclipse 中所有快捷键设置导出到一个 csv 格式的文件中，却没有导入按钮。为什么以前用 Eclipse 没注意到这点，到了 IntelliJ IDEA 却需要呢，归根结底还是 IntelliJ IDEA 的快捷键需要换的缘故，虽然这东西是舶来品，但既然无法改变别人，那只能改变自己了~</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><span id="参考1"><a href="http://blog.csdn.net/jiangfuqiang/article/details/38553011" target="_blank" rel="external">jiangfuqiang的专栏 - 完整导出IntelliJ IDEA的快捷键</a>，其他几篇跟博主一模一样的文章应该都是 copy 的</span>  </li>
<li><span id="参考2"><a href="http://wiki.jikexueyuan.com/project/intellij-idea-tutorial/installation-directory-introduce.html" target="_blank" rel="external">极客学院的IntelliJ IDEA 相关核心文件和目录介绍之Mac 的配置文件保存路径</a></span>  </li>
<li><span id="参考3"><a href="http://color-themes.com/?view=index" target="_blank" rel="external">Color Themes - 多彩主题</a></span>  </li>
</ul>
<div class="note danger"><p><strong>版权声明：</strong> 本文章转载请注明出处！ </p>
</div>]]></content>
      
        <categories>
            
            <category> IDE </category>
            
            <category> IntelliJ IDEA </category>
            
        </categories>
        
        
        <tags>
            
            <tag> IDE </tag>
            
            <tag> IntelliJ IDEA </tag>
            
            <tag> 快捷键 </tag>
            
            <tag> 配置 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Hello World - Hexo]]></title>
      <url>/2017/04/30/20170430%20-%20hello-world-hexo/</url>
      <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
      
        <categories>
            
            <category> 博客 </category>
            
            <category> 搭建 </category>
            
            <category> Hexo </category>
            
        </categories>
        
        
        <tags>
            
            <tag> 博客 </tag>
            
            <tag> blog </tag>
            
            <tag> hexo </tag>
            
            <tag> Hello World </tag>
            
            <tag> 命令行 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[博客搭建之Hexo系列]]></title>
      <url>/2017/04/30/20170430%20-%20%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E4%B9%8B%20Hexo%20%E7%B3%BB%E5%88%97/</url>
      <content type="html"><![CDATA[<p>&emsp;&emsp;其实每一项网上多找找都可以找到相应的文章，我也是借鉴了各种前人的总结才搭建出来的，但是把自己的结果整理出来比参考他人更花时间和精力。在学习中也发现了一些过时或不正确的内容，这里只记录真正实现过的功能，这也算是本博客的特色，给看的人负责，也是对自己的回顾。<br><a id="more"></a><br>已完成  </p>
<p>未完成</p>
<ul>
<li>选择 Hexo 搭建个人博客 </li>
<li>安装 Hexo 前准备 Node.js  </li>
<li>安装 Hexo 前准备 Git  </li>
<li>Hexo 初体验 </li>
<li>Hexo 主题</li>
<li>绑定域名  </li>
<li>备案</li>
<li>网站收录    </li>
<li>公益404   </li>
<li>站内搜索  </li>
<li>评论系统  </li>
<li>访问统计  </li>
<li>分享功能 </li>
<li>RSS     </li>
<li>捐赠  </li>
</ul>
]]></content>
      
        <categories>
            
            <category> 博客 </category>
            
            <category> 搭建 </category>
            
            <category> Hexo </category>
            
        </categories>
        
        
        <tags>
            
            <tag> 博客 </tag>
            
            <tag> blog </tag>
            
            <tag> 搭建 </tag>
            
            <tag> hexo </tag>
            
            <tag> 系列 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[序言]]></title>
      <url>/2017/04/14/20170414%20-%20%E5%BA%8F%E8%A8%80/</url>
      <content type="html"><![CDATA[<p>&emsp;&emsp;开始入博客的坑，比想象中的难多了，光博客的搭建就可以写个系列了，至于能坚持多久，就让时间来验证吧，回顾过去，做好当前，展望未来足以。<br>&emsp;&emsp;这是一个信息爆炸的时代，也充斥着各种混淆视听的内容，我想把最关键的东西写在最前面，让看到文章的读者能够快速辨别这篇文章对他有没有用，至于后面的散文诗，算是一个历史的积累吧。<br><a id="more"></a></p>
]]></content>
      
        <categories>
            
            <category> 杂谈 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> 杂谈 </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
